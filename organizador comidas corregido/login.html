<!DOCTYPE html>
<html lang="es">
<head><meta charset="utf-8"><title>Login - Plato Resuelto</title></head>
<body>
  <h1>Iniciá sesión</h1>
  <button id="loginBtn">Login con Google</button>
  <p id="status">Esperando login...</p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence,
      signInWithRedirect,
      getRedirectResult
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBgyXUiZPdYlWQBclhhH70mfRuIXIuw2EE",
      authDomain: "plato-resuelto.firebaseapp.com",
      projectId: "plato-resuelto",
      storageBucket: "plato-resuelto.firebasestorage.app",
      messagingSenderId: "11080746612",
      appId: "1:11080746612:web:22f488078f01def94ff321",
      measurementId: "G-16RQJ5KB0H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const loginBtn = document.getElementById("loginBtn");
    const status = document.getElementById("status");

    // Si ya vino de un redirect, procesalo (necesario si usamos signInWithRedirect)
    getRedirectResult(auth).then((result) => {
      if (result && result.user) {
        // onAuthStateChanged también lo detectará; opcional redirección directa
        window.location.href = "index.html";
      }
    }).catch(err => {
      console.warn("getRedirectResult:", err);
    });

    // onAuthStateChanged: redirige cuando el usuario esté presente
    onAuthStateChanged(auth, (user) => {
      if (user) {
        status.innerText = `Hola, ${user.displayName}`;
        window.location.href = "index.html";
      }
    });

    loginBtn.addEventListener("click", async () => {
      // INTENTO 1: forzar persistencia en localStorage (menos propenso a perder estado)
      try {
        await setPersistence(auth, browserLocalPersistence);
        await signInWithPopup(auth, provider);
        // onAuthStateChanged hará la redirección
      } catch (err) {
        console.error("signInWithPopup error:", err);
        // Si falla por storage/estado, hacer fallback a redirect (funciona mejor en browsers restrictivos)
        try {
          console.warn("Fallback a signInWithRedirect...");
          await signInWithRedirect(auth, provider);
          // con redirect la app se recargará y getRedirectResult / onAuthStateChanged lo manejarán
        } catch (err2) {
          console.error("signInWithRedirect también falló:", err2);
          alert("Error al iniciar sesión. Mirá la consola para más detalles.");
        }
      }
    });
  </script>
</body>
</html>


